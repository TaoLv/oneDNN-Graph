<!-- HTML header for doxygen 1.8.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>oneDNN Graph: CPU example for data conversion.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script src="assets/mathjax/MathJax.js?config=TeX-AMS_CHTML,dnnl"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="assets/customdoxygen.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="assets/dnn.js"></script>
</head>
<body>
<div class="mobile-nav"><i id="nav-btn"></i><a href="index.html">oneAPI Deep Neural Network Library Graph API (oneDNN Graph)</a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
   <div id="projectname">
     <a href="index.html">
      <div id="full-name">oneAPI Deep Neural Network Library Graph API (oneDNN Graph)</div>
    </a>
   </div>
   <div id="projectbrief">Performance Library for DNN Graph Optimization</div>
   <div id="projectnumber">0.2.0</div>
  <div>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('cpu_conversion_simple_pattern_cpp.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">CPU example for data conversion. </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><blockquote class="doxtable">
<p>Example code: <a class="el" href="cpu_conversion_simple_pattern_8cpp-example.html">cpu_conversion_simple_pattern.cpp</a> </p>
</blockquote>
<p>This example aims to demonstrate the usage of data conversion API.</p>
<p>If a tensor has a different layout with backend preferred layout, users can pre-allocate memory buffer and use this API to convert layout. If possible, users can also cache this memory buffer for futher reuse and hence improve performance. Besides that, this API also supports data conversion between different data types, like <code>fp32&lt;-&gt;bf16/fp16</code>.</p>
<p>Constructs a graph for further analysis </p><div class="fragment"><div class="line">    graph g(engine_kind);</div>
</div><!-- fragment --><p>Creates logical tensors for those inputs and outputs of the OPs, which will be used to define the connection relationship between OPs. </p><div class="fragment"><div class="line">    logical_tensor conv0_src_desc {id_mgr[<span class="stringliteral">&quot;conv0_src&quot;</span>], data_type::f32, input_dims, layout_type::strided};</div>
<div class="line">    logical_tensor conv0_weight_desc {id_mgr[<span class="stringliteral">&quot;conv0_weight&quot;</span>], data_type::f32, conv0_weight_dims, layout_type::any};</div>
<div class="line">    logical_tensor conv0_dst_desc {id_mgr[<span class="stringliteral">&quot;conv0_dst&quot;</span>], data_type::f32, conv0_dst_dims, layout_type::strided};</div>
<div class="line">    </div>
<div class="line">    op conv0(id_mgr[<span class="stringliteral">&quot;conv0&quot;</span>], op::kind::Convolution, {conv0_src_desc, conv0_weight_desc}, {conv0_dst_desc}, <span class="stringliteral">&quot;conv0&quot;</span>);</div>
<div class="line">    conv0.set_attr(<span class="stringliteral">&quot;strides&quot;</span>, std::vector&lt;int64_t&gt; {1, 1});</div>
<div class="line">    conv0.set_attr(<span class="stringliteral">&quot;pads_begin&quot;</span>, std::vector&lt;int64_t&gt; {0, 0});</div>
<div class="line">    conv0.set_attr(<span class="stringliteral">&quot;pads_end&quot;</span>, std::vector&lt;int64_t&gt; {0, 0});</div>
<div class="line">    conv0.set_attr(<span class="stringliteral">&quot;dilations&quot;</span>, std::vector&lt;int64_t&gt; {1, 1});</div>
<div class="line">    conv0.set_attr(<span class="stringliteral">&quot;data_format&quot;</span>, std::string(<span class="stringliteral">&quot;NXC&quot;</span>));</div>
<div class="line">    conv0.set_attr(<span class="stringliteral">&quot;filter_format&quot;</span>, std::string(<span class="stringliteral">&quot;OIX&quot;</span>));</div>
<div class="line">    conv0.set_attr(<span class="stringliteral">&quot;groups&quot;</span>, int64_t {1});</div>
<div class="line"> </div>
<div class="line">    logical_tensor relu0_dst_desc {id_mgr[<span class="stringliteral">&quot;relu0_dst&quot;</span>], data_type::f32, conv0_dst_dims, layout_type::strided};</div>
<div class="line">    </div>
<div class="line">    op relu0(id_mgr[<span class="stringliteral">&quot;relu0&quot;</span>], op::kind::ReLU, {conv0_dst_desc}, {relu0_dst_desc}, <span class="stringliteral">&quot;relu0&quot;</span>);</div>
</div><!-- fragment --><p>Select OP</p>
<p>Adds all of OPs into the created graph. Graph inside will maintain a list to store all these OPs. </p><div class="fragment"><div class="line">    g.add_op(conv0);</div>
<div class="line">    g.add_op(relu0);</div>
</div><!-- fragment --><p>Builds graph based on the selected Ops and gets partitions according to the patition policy and pre-defined pattern list. In this example, the graph will be filtered into a single partition: <code>conv+relu</code>.</p>
<dl class="section note"><dt>Note</dt><dd>Setting <code>DNNL_GRAPH_DUMP=1</code> can save internal graphs into dot files before/after graph fusion.</dd></dl>
<div class="fragment"><div class="line">    <span class="keyword">auto</span> partitions = g.get_partitions();</div>
</div><!-- fragment --><p>mark the output logical tensors of partition as ANY layout enabled</p>
<p>Create an <code>engine</code> according to <code>engine_kind</code> and <code>device_id</code>. Then, create a <code>stream</code> based on this engine </p><div class="fragment"><div class="line">    <span class="keywordtype">int</span> device_id = 0;</div>
<div class="line">    engine e {engine_kind, device_id};</div>
<div class="line">    stream s {e};</div>
</div><!-- fragment --><p>replace input logical tensor with the queried one</p>
<p>update output logical tensors with ANY layout</p>
<p>Compile the partition to generate compiled partition based on the input and output logical tensors. </p><div class="fragment"><div class="line">            c_partitions[i] = partitions[i].compile(inputs, outputs, e);</div>
</div><!-- fragment --><p>Convert data to the opaque layout which is determined by the backend. Here, we can query the logical tensor of <code>weight</code> tensor. And then, compare the logical tensor created by users with the queried from compiled partition. If the layouts are different, users can pre-allocate memory buffer and use conversion API to convert <code>weight</code> tensor to the best layout. </p><div class="fragment"><div class="line">            tm.convert_tensor_with_queried_format(input_ts, inputs, c_partitions[i].query_logical_tensor(id_mgr[<span class="stringliteral">&quot;conv0_weight&quot;</span>]), e, s);</div>
</div><!-- fragment --><p>Executes the compiled partition on the specified stream. </p><div class="fragment"><div class="line">            c_partitions[i].execute(s, input_ts, output_ts);</div>
</div><!-- fragment --><p>Users need to write implementation code by themselves. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div class="footer">
    <script>
        $('#top').prependTo($('#side-nav'));
    </script>
    <div class="footer-wrapper">
        <hr>
        <ul class="footer-links">
            <li><a href="legal_information.html">Legal information</a></li>
        </ul>
    </div>
</div>